<!DOCTYPE html>

<html>
<head>
  <title>Stub Adapter</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="stub-adapter">Stub Adapter</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>An adapter that stubs the adapter API for testing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Promise = <span class="hljs-built_in">require</span> <span class="hljs-string">'bluebird'</span>
AsyncPool = <span class="hljs-built_in">require</span> <span class="hljs-string">'async-pool'</span>
logger = (<span class="hljs-built_in">require</span> <span class="hljs-string">'logger-facade-nodejs'</span>).getLogger(<span class="hljs-string">'xwrap'</span>)

exports.initialize = <span class="hljs-function"><span class="hljs-params">(settings)</span>-&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StubAdapter(settings)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StubAdapter</span></span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(settings)</span>-&gt;</span>
    <span class="hljs-property">@settings</span> = settings
    <span class="hljs-property">@pool</span> = <span class="hljs-keyword">new</span> AsyncPool([<span class="hljs-keyword">new</span> StubClient(<span class="hljs-string">'A'</span>), <span class="hljs-keyword">new</span> StubClient(<span class="hljs-string">'B'</span>)])

  <span class="hljs-attribute">query</span>: <span class="hljs-function"><span class="hljs-params">(text)</span>-&gt;</span>
    Promise.using <span class="hljs-property">@xtransaction</span>.client(), <span class="hljs-function"><span class="hljs-params">(client)</span>-&gt;</span>
        client.query(text)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Get a client. Use with <code>Promise.using</code> in order to ensure client is
put back properly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">getRawClient</span>: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@pool</span>.use()

  <span class="hljs-attribute">enableTransactions</span>: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@transactionsEnabled</span> = <span class="hljs-literal">true</span>

  <span class="hljs-attribute">disableTransactions</span>: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-property">@transactionsEnabled</span> = <span class="hljs-literal">false</span>

  <span class="hljs-attribute">openTransaction</span>: <span class="hljs-function"><span class="hljs-params">(client)</span>-&gt;</span>
    client.query(<span class="hljs-string">'begin'</span>)

  <span class="hljs-attribute">openSubTransaction</span>: <span class="hljs-function"><span class="hljs-params">(client, name)</span>-&gt;</span>
    client.query(<span class="hljs-string">"savepoint \"<span class="hljs-subst">#{name}</span>\""</span>)

  <span class="hljs-attribute">commitTransaction</span>: <span class="hljs-function"><span class="hljs-params">(client)</span>-&gt;</span>
    client.query(<span class="hljs-string">"commit"</span>)

  <span class="hljs-attribute">commitSubTransaction</span>: <span class="hljs-function"><span class="hljs-params">(client, name)</span>-&gt;</span>
    client.query(<span class="hljs-string">"release \"<span class="hljs-subst">#{name}</span>\""</span>)

  <span class="hljs-attribute">rollbackTransaction</span>: <span class="hljs-function"><span class="hljs-params">(client)</span>-&gt;</span>
    client.query(<span class="hljs-string">"rollback"</span>)

  <span class="hljs-attribute">rollbackSubTransaction</span>: <span class="hljs-function"><span class="hljs-params">(client, name)</span>-&gt;</span>
    client.query(<span class="hljs-string">"rollback to \"<span class="hljs-subst">#{name}</span>\""</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StubClient</span></span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(name)</span>-&gt;</span>
    <span class="hljs-property">@name</span> = name

  <span class="hljs-attribute">query</span>: <span class="hljs-function"><span class="hljs-params">(text)</span>-&gt;</span>
    logger.trace(<span class="hljs-string">"query client <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>: <span class="hljs-subst">#{text}</span>"</span>)
    <span class="hljs-keyword">new</span> Promise (res)-&gt;
      setTimeout -&gt;
        res()
      , <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><a href="./index.html"><strong>Home</strong></a></p>

            </div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
